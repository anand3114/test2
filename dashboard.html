<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Student Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root {
      --bg: #f4f6fc;
      --text: #1c1c1c;
      --card: #fff;
      --accent: #3f83f8;
      --accent-dark: #2b66d1;
    }
    body {
      font-family: 'Inter', sans-serif;
      margin: 0; padding: 30px 20px;
      background: var(--bg);
      color: var(--text);
    }
    .card {
      max-width: 600px;
      background: var(--card);
      margin: auto;
      padding: 30px;
      border-radius: 16px;
      box-shadow: 0 8px 25px rgba(0,0,0,0.1);
      text-align: center;
    }
    button#viewMoreBtn {
      margin-top: 20px;
      padding: 10px;
      border-radius: 8px;
      border: none;
      background: var(--accent);
      color: white;
      font-weight: 600;
      cursor: pointer;
    }
    #subjectCharts {
      display: flex;
      flex-wrap: wrap;
      gap: 20px;
      justify-content: center;
      margin-top: 20px;
    }
    .subjectDiv {
      width: 200px;
      background: #fff;
      padding: 15px;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      text-align: center;
    }
  </style>
</head>
<body>
  <h1>Your Attendance Dashboard</h1>
  <div id="dashboard">Loading...</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.9.0/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.9.0/firebase-auth.js";
import { getFirestore, doc, getDoc, collection, getDocs } from "https://www.gstatic.com/firebasejs/11.9.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyBVIU4-cNma6fZCef2BQaGOo307TGBDk50",
  authDomain: "attendance311.firebaseapp.com",
  projectId: "attendance311",
  storageBucket: "attendance311.firebasestorage.app",
  messagingSenderId: "564903256212",
  appId: "1:564903256212:web:37dae9a02e39abbf3dd481",
  measurementId: "G-NZEEX42J3P"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

const container = document.getElementById("dashboard");

onAuthStateChanged(auth, async (user) => {
  if (!user) {
    alert("Please log in first.");
    window.location.href = "index.html";
    return;
  }

  const uid = user.uid;

  try {
    const docRef = doc(db, "attendance", uid);
    const docSnap = await getDoc(docRef);

    if (!docSnap.exists()) {
      container.innerHTML = `<div class="card"><p>No attendance record found.</p></div>`;
      return;
    }

    const data = docSnap.data();
    const total = data.totalClasses || 0;
    const present = data.totalPresent || 0;
    const absent = data.totalAbsent || 0;
    const percent = total > 0 ? ((present / total) * 100).toFixed(2) : 0;

    container.innerHTML = `
      <div class="card">
        <h2>Welcome, ${user.email}</h2>
        <p><strong>Total Classes:</strong> ${total}</p>
        <p><strong>Present:</strong> ${present}</p>
        <p><strong>Absent:</strong> ${absent}</p>
        <p><strong>Attendance %:</strong> ${percent}%</p>
        <canvas id="attendanceChart" style="max-width: 300px; margin: 0 auto;"></canvas>
        <button id="viewMoreBtn">View More</button>
        <div id="subjectDetails" style="display:none;">
          <h3>Attendance by Subject</h3>
          <div id="subjectCharts"></div>
        </div>
      </div>
    `;

    // Draw overall attendance chart
    const ctx = document.getElementById('attendanceChart').getContext('2d');
    new Chart(ctx, {
      type: 'pie',
      data: {
        labels: ['Present', 'Absent'],
        datasets: [{
          data: [present, absent],
          backgroundColor: ['#3f83f8', '#f87171']
        }]
      },
      options: {
        responsive: true,
        plugins: {
          legend: { position: 'bottom' }
        }
      }
    });

    const viewMoreBtn = document.getElementById('viewMoreBtn');
    const subjectDetails = document.getElementById('subjectDetails');
    const subjectCharts = document.getElementById('subjectCharts');

    let subjectsLoaded = false;

    viewMoreBtn.addEventListener('click', async () => {
      if (subjectDetails.style.display === 'none') {
        subjectDetails.style.display = 'block';
        viewMoreBtn.textContent = 'Hide Details';

        if (!subjectsLoaded) {
          subjectCharts.innerHTML = 'Loading subjects...';
          try {
            const subjectsRef = collection(db, "attendance", uid, "subjects");
            const subjectsSnap = await getDocs(subjectsRef);

            if (subjectsSnap.empty) {
              subjectCharts.innerHTML = '<p>No subject-wise attendance data found.</p>';
            } else {
              subjectCharts.innerHTML = ''; // Clear previous

              subjectsSnap.forEach(doc => {
                const subjectData = doc.data();
                const subjectName = doc.id;
                const totalClasses = subjectData.totalClasses || 0;
                const present = subjectData.present || 0;
                const absent = totalClasses - present;

                // Create subject card div
                const subjectDiv = document.createElement('div');
                subjectDiv.className = 'subjectDiv';
                subjectDiv.innerHTML = `
                  <h4>${subjectName}</h4>
                  <canvas id="chart-${subjectName}" width="150" height="150"></canvas>
                  <p><strong>Total:</strong> ${totalClasses}<br><strong>Present:</strong> ${present}<br><strong>Absent:</strong> ${absent}</p>
                `;

                subjectCharts.appendChild(subjectDiv);

                // Draw chart for subject
                const ctxSub = subjectDiv.querySelector('canvas').getContext('2d');
                new Chart(ctxSub, {
                  type: 'pie',
                  data: {
                    labels: ['Present', 'Absent'],
                    datasets: [{
                      data: [present, absent],
                      backgroundColor: ['#3f83f8', '#f87171']
                    }]
                  },
                  options: {
                    responsive: false,
                    plugins: {
                      legend: { position: 'bottom' }
                    }
                  }
                });
              });
            }
          } catch (err) {
            console.error('Error loading subjects:', err);
            subjectCharts.innerHTML = '<p>Error loading subjects.</p>';
          }
          subjectsLoaded = true;
        }
      } else {
        subjectDetails.style.display = 'none';
        viewMoreBtn.textContent = 'View More';
      }
    });

  } catch (error) {
    console.error("Error fetching attendance data:", error);
    container.innerHTML = `<div class="card"><p>Error loading attendance data.</p></div>`;
  }
});
</script>
</body>
</html>
