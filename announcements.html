<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>📢 Announcements</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Inter', sans-serif;
      background: #f0f9ff;
      padding: 20px;
      color: #1e293b;
    }
    h1 {
      text-align: center;
      margin-bottom: 30px;
    }
    .announcement {
      background: white;
      padding: 20px;
      margin-bottom: 20px;
      border-radius: 10px;
      box-shadow: 0 0 8px rgba(0,0,0,0.05);
    }
    .announcement h3 {
      margin-top: 0;
      color: #1d4ed8;
    }
    .announcement small {
      color: gray;
    }
    .reaction-btn, .edit-btn, .delete-btn {
      margin: 5px 10px 5px 0;
      padding: 5px 10px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }
    .reaction-btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }
    .edit-btn { background: #4f46e5; color: white; }
    .delete-btn { background: #dc2626; color: white; }
    .comment-box {
      margin-top: 15px;
    }
    .comment-box textarea {
      width: 100%;
      padding: 8px;
      border: 1px solid #ccc;
      border-radius: 6px;
      resize: vertical;
    }
    .comment-box button {
      margin-top: 5px;
    }
    .comment {
      background: #f9fafb;
      padding: 8px 10px;
      border-radius: 6px;
      margin-top: 5px;
    }
  </style>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.9.0/firebase-app.js";
    import {
      getFirestore, collection, query, orderBy, onSnapshot,
      updateDoc, doc, increment, getDoc, setDoc, addDoc,
      deleteDoc
    } from "https://www.gstatic.com/firebasejs/11.9.0/firebase-firestore.js";
    import {
      getAuth, onAuthStateChanged
    } from "https://www.gstatic.com/firebasejs/11.9.0/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBVIU4-cNma6fZCef2BQaGOo307TGBDk50",
      authDomain: "attendance311.firebaseapp.com",
      projectId: "attendance311",
      storageBucket: "attendance311.appspot.com",
      messagingSenderId: "564903256212",
      appId: "1:564903256212:web:37dae9a02e39abbf3dd481",
      measurementId: "G-NZEEX42J3P"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    const container = document.getElementById("announcement-list");
    const ADMIN_EMAIL = "anand31145@gmail.com";

    let currentUser;

    onAuthStateChanged(auth, user => {
      if (!user) {
        alert("Please log in.");
        location.href = "index.html";
        return;
      }
      currentUser = user;
      const isAdmin = user.email === ADMIN_EMAIL;
      loadAnnouncements(isAdmin);
    });

    function getEmoji(type) {
      return { like: "👍", love: "❤️", laugh: "😂", wow: "😮" }[type];
    }

    function loadAnnouncements(isAdmin) {
      const q = query(collection(db, "announcements"), orderBy("date", "desc"));
      onSnapshot(q, async (snapshot) => {
        container.innerHTML = "";
        for (const docSnap of snapshot.docs) {
          const data = docSnap.data();
          const id = docSnap.id;
          const dateText = data.date?.toDate().toLocaleString() || "Unknown";
          const reactions = data.reactions || {};

          const annRef = doc(db, "announcements", id);
          const userReactRef = doc(db, "users", currentUser.uid, "likes", id);
          const userReactDoc = await getDoc(userReactRef);
          const hasReacted = userReactDoc.exists();

          const annCard = document.createElement("div");
          annCard.className = "announcement";
          annCard.innerHTML = `
            <h3>${data.title || "Untitled"}</h3>
            <small>${dateText}</small>
            <p>${data.content || ""}</p>
          `;

          const reactionDiv = document.createElement("div");
          ["like", "love", "laugh", "wow"].forEach(type => {
            const btn = document.createElement("button");
            btn.className = "reaction-btn";
            btn.textContent = `${getEmoji(type)} ${reactions[type] || 0}`;
            btn.disabled = hasReacted;
            btn.onclick = async () => {
              await updateDoc(annRef, { [`reactions.${type}`]: increment(1) });
              await setDoc(userReactRef, { reacted: true });
            };
            reactionDiv.appendChild(btn);
          });

          if (isAdmin) {
            const editBtn = document.createElement("button");
            editBtn.className = "edit-btn";
            editBtn.textContent = "Edit";
            editBtn.onclick = () => alert(`Editing announcement ${id}...`);

            const delBtn = document.createElement("button");
            delBtn.className = "delete-btn";
            delBtn.textContent = "Delete";
            delBtn.onclick = async () => {
              if (confirm("Are you sure you want to delete this announcement?")) {
                await deleteDoc(annRef);
              }
            };

            reactionDiv.appendChild(editBtn);
            reactionDiv.appendChild(delBtn);
          }

          annCard.appendChild(reactionDiv);

          // Comment section
          const commentBox = document.createElement("div");
          commentBox.className = "comment-box";

          const commentInput = document.createElement("textarea");
          commentInput.placeholder = "Write a comment...";
          const commentBtn = document.createElement("button");
          commentBtn.textContent = "Post";
          commentBtn.onclick = async () => {
            const text = commentInput.value.trim();
            if (text) {
              await addDoc(collection(db, `announcements/${id}/comments`), {
                text,
                user: currentUser.email,
                time: new Date()
              });
              commentInput.value = "";
            }
          };

          commentBox.appendChild(commentInput);
          commentBox.appendChild(commentBtn);

          const commentsRef = collection(db, `announcements/${id}/comments`);
          onSnapshot(commentsRef, (commentSnap) => {
            const existing = annCard.querySelectorAll(".comment");
            existing.forEach(e => e.remove());
            commentSnap.forEach(doc => {
              const c = document.createElement("div");
              c.className = "comment";
              c.textContent = `${doc.data().user}: ${doc.data().text}`;
              annCard.appendChild(c);
            });
          });

          annCard.appendChild(commentBox);
          container.appendChild(annCard);
        }
      });
    }
  </script>
</head>
<body>
  <h1>📢 Latest Announcements</h1>
  <div id="announcement-list">Loading...</div>
</body>
</html>
